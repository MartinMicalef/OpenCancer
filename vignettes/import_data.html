<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Lino Galiana" />

<meta name="date" content="2018-02-05" />

<title>Building cancer dataset for Epidemium challenge</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Building cancer dataset for Epidemium challenge</h1>
<h4 class="author"><em>Lino Galiana</em></h4>
<h4 class="date"><em>2018-02-05</em></h4>



<div id="requirement" class="section level1">
<h1>Requirement</h1>
<p>This <code>Vignette</code> presents the methodology that allows to import Epidemium data and merge them. The following <a href="http://qa.epidemium.cc/data/epidemiology_dataset/">Epidemium data</a> will be used</p>
<ul>
<li><a href="%22http://qa.epidemium.cc/data/epidemiology_dataset/fao_data/Faostat_Data.csv%22">Faostat_Data.csv</a></li>
<li><a href="%22http://qa.epidemium.cc/data/epidemiology_dataset/ilo_data/Ilostat_Data.csv%22">Ilostat_Data.csv`</a></li>
<li><a href="%22http://qa.epidemium.cc/data/shinyapp/training_IARC.csv%22">training_IARC.csv</a></li>
<li><a href="%22http://qa.epidemium.cc/data/epidemiology_dataset/world_bank_data/WorldBank_Data.csv%22">WorldBank_Data.csv</a></li>
</ul>
<p><code>training_IARC.csv</code> has been preferred to <a href="%22http://qa.epidemium.cc/data/incidence_dataset/2017-10-10_dataset_core/training.txt%22">training.txt</a>, the latter exhibting more missing values.</p>
<p>To ensure <code>Vignette</code> compilation, every dataframe is downloaded from the internet. It might be time-consuming. It is thus recommended to rather manually download required files using a web browser, put them in a subdirectory within the working directory. We called this directory <code>datadir</code> in this <code>Vignette</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
datadir &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">getwd</span>(),<span class="st">&quot;/inst&quot;</span>)</code></pre></div>
<p>If all the required files can be find in <code>datadir</code>, you can safely use our functions without the web-import option. All the <code>import_</code> functions should work when setting <code>fromURL = F</code> and the speed gain should be around 50%. The <code>filename</code> and <code>path</code> arguments have been filled for that: they are not necessary when importing data from the internet but are necessary if you upload from a computer.</p>
<p>The only required package in this <code>Vignette</code> is</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw">library</span>(OpenCancer)</code></pre></div>
</div>
<div id="importing-dataframes" class="section level1">
<h1>Importing dataframes</h1>
<div id="importing-covariates" class="section level2">
<h2>Importing covariates</h2>
<p>The <code>import_*</code> functions share the same structure. The parameters <code>colstokeep</code> allow to only keep a few variables. If <code>colstokeep = NULL</code>, all variables are kept in memory. In this <code>Vignette</code>, we will only keep a few variables in memory (100 variables) but, if you want the whole dataframes, replicate these examples with <code>colstokeep = NULL</code>.</p>
<p>FAO data can be imported with <code>import_FAO</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_FAO &lt;-<span class="st"> </span><span class="kw">import_FAO</span>(<span class="dt">path =</span> datadir, <span class="dt">colstokeep =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="dt">fromURL =</span> T)
knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(df_FAO[<span class="op">!</span><span class="kw">is.na</span>(df_FAO[,<span class="dv">10</span>]),<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]), <span class="dt">caption =</span> <span class="st">&quot;FAO Data&quot;</span>)</code></pre></div>
<table>
<caption>FAO Data</caption>
<thead>
<tr class="header">
<th align="left">area</th>
<th align="right">year</th>
<th align="right">101..5312</th>
<th align="right">101..5419</th>
<th align="right">101..5510</th>
<th align="right">101..5525</th>
<th align="right">1012..5322</th>
<th align="right">1012..5417</th>
<th align="right">1012..5510</th>
<th align="right">1016..5111</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1961</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">4336000</td>
<td align="right">141</td>
<td align="right">61138</td>
<td align="right">4200000</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1962</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">4355000</td>
<td align="right">140</td>
<td align="right">60970</td>
<td align="right">4087270</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1963</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">4673000</td>
<td align="right">139</td>
<td align="right">64955</td>
<td align="right">3800000</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1964</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">5010000</td>
<td align="right">140</td>
<td align="right">70140</td>
<td align="right">3500000</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1965</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">5179000</td>
<td align="right">141</td>
<td align="right">73024</td>
<td align="right">3200000</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1966</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">5366000</td>
<td align="right">140</td>
<td align="right">75124</td>
<td align="right">3200000</td>
</tr>
</tbody>
</table>
<p>World Bank data are imported with <code>import_WB</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_WB &lt;-<span class="st"> </span><span class="kw">import_WB</span>(<span class="dt">path =</span> datadir, <span class="dt">colstokeep =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="dt">fromURL =</span> T)
knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(df_WB[<span class="op">!</span><span class="kw">is.na</span>(df_WB[,<span class="dv">6</span>]),<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]), <span class="dt">caption =</span> <span class="st">&quot;World Bank Data&quot;</span>)</code></pre></div>
<table>
<caption>World Bank Data</caption>
<thead>
<tr class="header">
<th align="left">area_code</th>
<th align="left">area</th>
<th align="right">year</th>
<th align="right">SE.ADT.1524.LT.FE.ZS</th>
<th align="right">SE.ADT.1524.LT.FM.ZS</th>
<th align="right">SE.ADT.1524.LT.MA.ZS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ABW</td>
<td align="left">Aruba</td>
<td align="right">2000</td>
<td align="right">99.16637</td>
<td align="right">1.00288</td>
<td align="right">98.88176</td>
</tr>
<tr class="even">
<td align="left">ABW</td>
<td align="left">Aruba</td>
<td align="right">2010</td>
<td align="right">99.32310</td>
<td align="right">1.00361</td>
<td align="right">98.96573</td>
</tr>
<tr class="odd">
<td align="left">ABW</td>
<td align="left">Aruba</td>
<td align="right">2015</td>
<td align="right">99.36831</td>
<td align="right">0.99913</td>
<td align="right">99.45435</td>
</tr>
<tr class="even">
<td align="left">AFG</td>
<td align="left">Afghanistan</td>
<td align="right">1979</td>
<td align="right">11.14280</td>
<td align="right">0.24331</td>
<td align="right">45.79602</td>
</tr>
<tr class="odd">
<td align="left">AFG</td>
<td align="left">Afghanistan</td>
<td align="right">2011</td>
<td align="right">32.11322</td>
<td align="right">0.51897</td>
<td align="right">61.87907</td>
</tr>
<tr class="even">
<td align="left">AFG</td>
<td align="left">Afghanistan</td>
<td align="right">2015</td>
<td align="right">46.10599</td>
<td align="right">0.66416</td>
<td align="right">69.42052</td>
</tr>
</tbody>
</table>
<p>ILO data are imported with <code>import_ILO</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_ILO &lt;-<span class="st"> </span><span class="kw">import_ILO</span>(<span class="dt">path =</span> datadir, <span class="dt">colstokeep =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="dt">fromURL =</span> T)
knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(df_ILO[<span class="op">!</span><span class="kw">is.na</span>(df_ILO[,<span class="dv">6</span>]),<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">ref_area</th>
<th align="left">area</th>
<th align="right">year</th>
<th align="right">EAP_DWAF_NOC_RT..NOC_VALUE</th>
<th align="right">EAP_DWAM_NOC_RT..NOC_VALUE</th>
<th align="right">EAP_DWAP_NOC_RT..NOC_VALUE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ABW</td>
<td align="left">Aruba</td>
<td align="right">2010</td>
<td align="right">59.52</td>
<td align="right">68.92</td>
<td align="right">63.91</td>
</tr>
<tr class="even">
<td align="left">ABW</td>
<td align="left">Aruba</td>
<td align="right">2011</td>
<td align="right">58.80</td>
<td align="right">69.60</td>
<td align="right">63.80</td>
</tr>
<tr class="odd">
<td align="left">ALB</td>
<td align="left">Albania</td>
<td align="right">2008</td>
<td align="right">52.80</td>
<td align="right">72.10</td>
<td align="right">61.94</td>
</tr>
<tr class="even">
<td align="left">ALB</td>
<td align="left">Albania</td>
<td align="right">2009</td>
<td align="right">51.80</td>
<td align="right">73.30</td>
<td align="right">61.90</td>
</tr>
<tr class="odd">
<td align="left">ALB</td>
<td align="left">Albania</td>
<td align="right">2010</td>
<td align="right">52.80</td>
<td align="right">72.20</td>
<td align="right">62.20</td>
</tr>
<tr class="even">
<td align="left">ALB</td>
<td align="left">Albania</td>
<td align="right">2011</td>
<td align="right">52.95</td>
<td align="right">67.88</td>
<td align="right">60.34</td>
</tr>
</tbody>
</table>
</div>
<div id="importing-training-data" class="section level2">
<h2>Importing training data</h2>
<p><code>import_training</code> data allows to import both <a href="%22http://qa.epidemium.cc/data/shinyapp/training_IARC.csv%22">training_IARC.csv</a> and <a href="%22http://qa.epidemium.cc/data/incidence_dataset/2017-10-10_dataset_core/training.txt%22">training.txt</a>. For its completeness, the former has been preferred.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_training &lt;-<span class="st"> </span><span class="kw">import_training</span>(<span class="dt">path =</span> datadir, <span class="dt">colstokeep =</span> <span class="ot">NULL</span>,
                                   <span class="dt">filename =</span> <span class="st">&quot;training_IARC.csv&quot;</span>,
                                   <span class="dt">fromURL =</span> <span class="ot">TRUE</span>,
                                   <span class="dt">url =</span> <span class="st">&quot;http://qa.epidemium.cc/data/shinyapp/training_IARC.csv&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(<span class="kw">na.omit</span>(df_training)), <span class="dt">caption =</span> <span class="st">&quot;Incidence Data&quot;</span>)</code></pre></div>
<table>
<caption>Incidence Data</caption>
<thead>
<tr class="header">
<th align="left">cancer</th>
<th align="right">sex</th>
<th align="right">age</th>
<th align="left">country</th>
<th align="left">region</th>
<th align="left">ethnicity</th>
<th align="right">year</th>
<th align="right">incidence</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">C18</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">USA</td>
<td align="left">California, Greater San Francisco Bay Area</td>
<td align="left">Non-Hispanic White</td>
<td align="right">1973</td>
<td align="right">21</td>
</tr>
<tr class="even">
<td align="left">C18</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="left">USA</td>
<td align="left">California, Greater San Francisco Bay Area</td>
<td align="left">Non-Hispanic White</td>
<td align="right">1973</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">C18</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="left">USA</td>
<td align="left">California, Greater San Francisco Bay Area</td>
<td align="left">Non-Hispanic White</td>
<td align="right">1973</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">C18</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="left">USA</td>
<td align="left">California, Greater San Francisco Bay Area</td>
<td align="left">Non-Hispanic White</td>
<td align="right">1973</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">C18</td>
<td align="right">1</td>
<td align="right">5</td>
<td align="left">USA</td>
<td align="left">California, Greater San Francisco Bay Area</td>
<td align="left">Non-Hispanic White</td>
<td align="right">1973</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">C18</td>
<td align="right">1</td>
<td align="right">6</td>
<td align="left">USA</td>
<td align="left">California, Greater San Francisco Bay Area</td>
<td align="left">Non-Hispanic White</td>
<td align="right">1973</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
<div id="importing-variables-codes" class="section level2">
<h2>Importing variables codes</h2>
<p>The following function has been designed to easily import from the Epidemium website the labels of all the variables names.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_label &lt;-<span class="st"> </span><span class="kw">import_coding</span>()</code></pre></div>
<p>It requires an internet connection since files are imported from <code>Epidemium</code> website.</p>
</div>
<div id="importing-joining-keys" class="section level2">
<h2>Importing joining keys</h2>
<p>To ensure data will be consistently merged, we import a file called <code>creation zonier.xls</code> file, stored in <code>Github</code>. All countries in the FAO, ILO and World Bank database should thus be assigned a unique and consistent key, a necessary step before merging dataframes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
link &lt;-<span class="st"> &quot;https://github.com/EpidemiumOpenCancer/OpenCancer/raw/master/vignettes/inst/creation%20zonier.xls&quot;</span>
<span class="kw">download.file</span>(link,<span class="dt">destfile =</span> <span class="kw">paste0</span>(datadir,<span class="st">&quot;/creation zonier.xls&quot;</span>),<span class="dt">mode =</span> <span class="st">&quot;wb&quot;</span>)
codes &lt;-<span class="st"> </span>readxl<span class="op">::</span><span class="kw">read_excel</span>(<span class="dt">path =</span> <span class="kw">paste0</span>(datadir,<span class="st">&quot;/creation zonier.xls&quot;</span>),
                            <span class="dt">sheet =</span> <span class="st">&quot;Transco_Country&quot;</span>)

knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(codes), <span class="dt">caption =</span> <span class="st">'Coding convention for countries'</span>)</code></pre></div>
<table>
<caption>Coding convention for countries</caption>
<thead>
<tr class="header">
<th align="left">Source</th>
<th align="left">Country_Source</th>
<th align="left">Country_Transco</th>
<th align="left">Zonier</th>
<th align="left">Continent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">World Bank</td>
<td align="left">Korea, Rep.</td>
<td align="left">South Korea</td>
<td align="left">B</td>
<td align="left">Asia</td>
</tr>
<tr class="even">
<td align="left">World Bank</td>
<td align="left">Mexico</td>
<td align="left">Mexico</td>
<td align="left">D</td>
<td align="left">Central America</td>
</tr>
<tr class="odd">
<td align="left">World Bank</td>
<td align="left">Peru</td>
<td align="left">Peru</td>
<td align="left">D</td>
<td align="left">South America</td>
</tr>
<tr class="even">
<td align="left">World Bank</td>
<td align="left">Morocco</td>
<td align="left">Morocco</td>
<td align="left">E</td>
<td align="left">Africa</td>
</tr>
<tr class="odd">
<td align="left">World Bank</td>
<td align="left">Costa Rica</td>
<td align="left">Costa Rica</td>
<td align="left">D</td>
<td align="left">Central America</td>
</tr>
<tr class="even">
<td align="left">World Bank</td>
<td align="left">Chile</td>
<td align="left">Chile</td>
<td align="left">C</td>
<td align="left">South America</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="merging-dataframes" class="section level1">
<h1>Merging dataframes</h1>
<div id="mapping-data-to-a-unique-key" class="section level2">
<h2>Mapping data to a unique key</h2>
<p>Using the <code>codes</code> dataframe, we use the <code>matchkeys</code> function to match countries in a dataframe (e.g. <code>df_FAO</code>) with its identifiers. It only requires to match a dataframe with its source (default is <em>‘FAO’</em>)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_FAO =<span class="st"> </span><span class="kw">matchkeys</span>(df_FAO,codes)
df_WB =<span class="st"> </span><span class="kw">matchkeys</span>(df_WB,codes,<span class="dt">origin =</span> <span class="st">&quot;World Bank&quot;</span>)
df_ILO =<span class="st"> </span><span class="kw">matchkeys</span>(df_ILO,codes, <span class="dt">origin =</span> <span class="st">&quot;IloStat&quot;</span>)</code></pre></div>
</div>
<div id="join-data" class="section level2">
<h2>Join data</h2>
<p>At this stage, all explanatory variables dataframes share consistent keys that allow to safely merge them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># LEFT JOIN FAO AND WORLD BANK DATA: NO RESTRICTION TO POST 1970 DATA</span>
df_covariates &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">full_join</span>(df_FAO,df_WB, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;Country_Transco&quot;</span>,<span class="st">&quot;year&quot;</span>,<span class="st">&quot;Zonier&quot;</span>))

<span class="co"># JOIN AVEC ILO</span>
df_covariates &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(df_covariates,df_ILO, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;Country_Transco&quot;</span>,<span class="st">&quot;year&quot;</span>,<span class="st">&quot;Zonier&quot;</span>))</code></pre></div>
<p>To ensure consistency with the training data, we control the countries that do not match with the keys list. The number is limited for both <code>training.txt</code> (8 countries) and <code>training.csv</code> (3 countries). This can be handled manually</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># CHANGING MISMATCHED NAMES WITH TRAINING DATASET</span>
oldnames &lt;-<span class="st"> </span><span class="kw">unique</span>(df_training<span class="op">$</span>country[<span class="op">!</span>df_training<span class="op">$</span>country <span class="op">%in%</span><span class="st"> </span>
<span class="st">                                         </span><span class="kw">intersect</span>(df_covariates<span class="op">$</span>Country_Transco,df_training<span class="op">$</span>country)])
newnames &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Netherlands&quot;</span>,<span class="st">&quot;Slovakia&quot;</span>,<span class="st">&quot;United States&quot;</span>)

<span class="co"># IF DATAFRAME IS training.csv UNCOMMENT</span>
<span class="co">#newnames &lt;- c(&quot;Netherlands&quot;,&quot;Slovakia&quot;,&quot;United States&quot;,&quot;Gambia, The&quot;,&quot;Australian Capital Territory&quot;,</span>
<span class="co">#              &quot;South Korea&quot;,&quot;VietNam&quot;,&quot;Yugoslavia&quot;)</span>
df_training<span class="op">$</span>country &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw">mapvalues</span>(df_training<span class="op">$</span>country, <span class="dt">from=</span>oldnames, <span class="dt">to=</span>newnames,
                                       <span class="dt">warn_missing =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p>The final step in the merging process is to join the incidence dataset with other variables</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># HARMONIZING COLUMN NAMES</span>
df_training  &lt;-<span class="st"> </span>df_training <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">Country_Transco =</span> country)

<span class="co"># IF NO ETHNICITY IS GIVEN, ASSUMED ALL POPULATION IS PRESENTED</span>
df_training<span class="op">$</span>ethnicity[<span class="kw">is.na</span>(df_training<span class="op">$</span>ethnicity)] &lt;-<span class="st"> &quot;All population&quot;</span> 
df_training<span class="op">$</span>region[<span class="kw">is.na</span>(df_training<span class="op">$</span>region)] &lt;-<span class="st"> &quot;All regions&quot;</span> 

<span class="co"># JOIN WITH TRAINING DATASET</span>
df_full &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(df_training,df_covariates)</code></pre></div>
<p>Finally, we clean the dataframe to get a proper training tables that can be interpolated. We ensure we don’t have empty columns with <code>check.emptycolumn</code> (to ensure we don’t have empty lines, we will later use <code>check.emptyline</code>)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># REMOVE UNNECESSARY VARIABLES</span>
df_full &lt;-<span class="st"> </span>df_full <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_</span>(<span class="dt">.dots =</span> <span class="kw">paste0</span>(<span class="st">&quot;-&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;cancer&quot;</span>, <span class="st">&quot;area.x&quot;</span>,<span class="st">&quot;area.y&quot;</span>,
             <span class="st">&quot;area_code&quot;</span>,<span class="st">&quot;ref_area&quot;</span>,
             <span class="st">&quot;area&quot;</span>,<span class="st">&quot;sourceFAO&quot;</span>,<span class="st">&quot;sourceWB&quot;</span>,<span class="st">&quot;sourceILO&quot;</span>))
)

df_full &lt;-<span class="st"> </span>df_full[,<span class="op">!</span><span class="kw">check.emptycolumn</span>(df_full)]

knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(df_full[<span class="op">!</span><span class="kw">is.na</span>(df_full[,<span class="dv">10</span>]),<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]), <span class="dt">caption =</span> <span class="st">'Final dataframe before interpolation'</span>)</code></pre></div>
<table>
<caption>Final dataframe before interpolation</caption>
<thead>
<tr class="header">
<th align="right">sex</th>
<th align="right">age</th>
<th align="left">Country_Transco</th>
<th align="left">region</th>
<th align="left">ethnicity</th>
<th align="right">year</th>
<th align="right">incidence</th>
<th align="right">101..5312</th>
<th align="right">101..5419</th>
<th align="right">101..5510</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="left">Australia</td>
<td align="left">New South Wales</td>
<td align="left">All population</td>
<td align="right">1983</td>
<td align="right">21</td>
<td align="right">9401</td>
<td align="right">9680</td>
<td align="right">9100</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2</td>
<td align="left">Australia</td>
<td align="left">New South Wales</td>
<td align="left">All population</td>
<td align="right">1983</td>
<td align="right">0</td>
<td align="right">9401</td>
<td align="right">9680</td>
<td align="right">9100</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">3</td>
<td align="left">Australia</td>
<td align="left">New South Wales</td>
<td align="left">All population</td>
<td align="right">1983</td>
<td align="right">0</td>
<td align="right">9401</td>
<td align="right">9680</td>
<td align="right">9100</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">4</td>
<td align="left">Australia</td>
<td align="left">New South Wales</td>
<td align="left">All population</td>
<td align="right">1983</td>
<td align="right">0</td>
<td align="right">9401</td>
<td align="right">9680</td>
<td align="right">9100</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">5</td>
<td align="left">Australia</td>
<td align="left">New South Wales</td>
<td align="left">All population</td>
<td align="right">1983</td>
<td align="right">0</td>
<td align="right">9401</td>
<td align="right">9680</td>
<td align="right">9100</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">6</td>
<td align="left">Australia</td>
<td align="left">New South Wales</td>
<td align="left">All population</td>
<td align="right">1983</td>
<td align="right">2</td>
<td align="right">9401</td>
<td align="right">9680</td>
<td align="right">9100</td>
</tr>
</tbody>
</table>
<p>To limit the amount of RAM required by R, we clean the global environment by removing dataframes that are no longer necessary. We also fix as a starting point <code>1970</code>, where all covariates dataframes are available.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
pryr<span class="op">::</span><span class="kw">mem_change</span>(<span class="kw">rm</span>(df_ILO,df_FAO,df_WB,df_training,
   df_covariates))
<span class="co">#&gt; -59.7 MB</span>

df_full &lt;-<span class="st"> </span>df_full <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year<span class="op">&gt;=</span><span class="dv">1970</span>)</code></pre></div>
</div>
</div>
<div id="cleaning-dataset" class="section level1">
<h1>Cleaning dataset</h1>
<div id="ensuring-variables-types-are-consistent" class="section level2">
<h2>Ensuring variables types are consistent</h2>
<p>The <code>OpenCancer</code> package provides several functions dedicated to the construction of a clean training table. First of all, it might be a good idea to drop empty variables, if there are some</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="cf">if</span> (<span class="kw">sum</span>(<span class="kw">check.emptycolumn</span>(df_full))<span class="op">&gt;</span><span class="dv">0</span>) df_full &lt;-<span class="st"> </span><span class="kw">check.emptycolumn</span>(df_full)</code></pre></div>
<p>More generally, we can inspect the share of missing values in a variable using <code>check.emptycolumn</code>. It might thus be a good idea to drop variables that have too much missing values since interpolation will show small precision with too much missing values. For instance, if we want to drop variables that have more of 40% of missing values (187 variables over 276), we do</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_full<span class="op">$</span>ethnicity[<span class="kw">is.na</span>(df_full<span class="op">$</span>ethnicity)] &lt;-<span class="st"> &quot;All population&quot;</span>

colstokeep &lt;-<span class="st"> </span><span class="op">!</span><span class="kw">check.emptycolumn</span>(df_full,<span class="dt">proportion =</span> T)<span class="op">&gt;</span><span class="fl">0.4</span>
df_full &lt;-<span class="st"> </span>df_full[,colstokeep]</code></pre></div>
<p>Another modification that might be useful is converting some variables into <code>factors</code>. The <code>check_factor</code> variable has been designed for that. First, if we want to inspect the cardinal of each potential factor, we use the argument <code>check.levels = T</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw">head</span>(<span class="kw">check.factor</span>(df_full,<span class="dt">check.levels =</span> T,<span class="dt">threshold =</span> <span class="dv">12</span>))
<span class="co">#&gt;         sex SE.PRE.DURS SE.PRM.AGES SE.PRM.DURS SE.SEC.AGES SE.SEC.DURS </span>
<span class="co">#&gt;           2           4           4           6           4           6</span></code></pre></div>
<p>Now, let’s say we want to convert each variable with cardinal lower than 12 as <code>factor</code>. In that case we must put <code>check.levels = F</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_full &lt;-<span class="st"> </span><span class="kw">check.factor</span>(df_full,<span class="dt">check.levels =</span> F,<span class="dt">threshold =</span> <span class="dv">12</span>)</code></pre></div>
<p>It might also be a good idea to exclude constant variables since they do not provide information when building statistical models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># VARIABLES WITH ZERO VARIANCE: CONSTANT VARIABLES -&gt; DROP THEM</span>
<span class="cf">if</span> (<span class="kw">sum</span>(<span class="kw">apply</span>(df_full[,<span class="op">!</span><span class="kw">sapply</span>(df_full, is.character)], <span class="dv">2</span>, var, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)<span class="op">&gt;</span><span class="dv">0</span>){
  df_full &lt;-<span class="st"> </span>df_full[,<span class="op">-</span><span class="kw">which</span>(<span class="kw">apply</span>(df_full[,<span class="op">!</span><span class="kw">sapply</span>(df_full, is.character)], <span class="dv">2</span>, var, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)]
}

<span class="kw">dim</span>(df_full)
<span class="co">#&gt; [1] 87172    89</span></code></pre></div>
</div>
</div>
<div id="interpolation" class="section level1">
<h1>Interpolation</h1>
<p>At this stage, <code>df_full</code> has 10336 complete rows over 89. Interpolating missing values might help to build robust statistical models. A series of function being part of the <code>OpenCancer</code> package have been specifically built to deal with missing values.</p>
<div id="ensuring-consistency-in-missing-values-treatment" class="section level2">
<h2>Ensuring consistency in missing values treatment</h2>
<p>A first useful function has been designed to identify potential miscoding issues. <code>convert_fakezero</code> has been designed to inspect variables where zeros might rather be <code>NAs</code>. We encapsulate the <code>convert_fakezero</code> call within a <code>mapvalues</code> call to print variables labels rather than codes that are obscure</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> 
<span class="kw">head</span>(plyr<span class="op">::</span><span class="kw">mapvalues</span>(<span class="kw">names</span>(<span class="kw">which</span>(<span class="kw">convert_fakezero</span>(df_full,<span class="dt">convert =</span> F))),
                <span class="dt">from =</span> df_label<span class="op">$</span>code,
                <span class="dt">to =</span> df_label<span class="op">$</span>label, <span class="dt">warn_missing =</span> <span class="ot">FALSE</span>)
)
<span class="co">#&gt; [1] &quot;incidence&quot;                                             </span>
<span class="co">#&gt; [2] &quot;Meat indigenous, sheep Production (tonnes)&quot;            </span>
<span class="co">#&gt; [3] &quot;Lard Production (tonnes)&quot;                              </span>
<span class="co">#&gt; [4] &quot;Ducks Stocks (1000 Head)&quot;                              </span>
<span class="co">#&gt; [5] &quot;Meat, duck Producing Animals/Slaughtered (1000 Head)&quot;  </span>
<span class="co">#&gt; [6] &quot;Meat, turkey Producing Animals/Slaughtered (1000 Head)&quot;</span></code></pre></div>
<p>For consumer price index variables, zero values make no sense. For food production variables, a zero value at national level (observation unit for <code>FAO</code> data) is not likely and might, once again, reflect coding issues. We thus convert, for all these variables except <code>incidence</code>, zeros as NAs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
potential.miscoding &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">names</span>(<span class="kw">which</span>(<span class="kw">convert_fakezero</span>(df_full,<span class="dt">convert =</span> F)))
miscoded &lt;-<span class="st"> </span>potential.miscoding[<span class="op">!</span>potential.miscoding <span class="op">%in%</span><span class="st"> &quot;incidence&quot;</span>]
<span class="kw">is.na</span>(df_full[,miscoded]) &lt;-<span class="st"> </span><span class="op">!</span>df_full[,miscoded]</code></pre></div>
</div>
<div id="interpolation-1" class="section level2">
<h2>Interpolation</h2>
<p>The <code>interpolate_data</code> function has been designed to give control when imputing NAs by the means of the <code>zoo::na.approx</code> function. In further release of the package, advanced options will be added (<code>knn</code> imputation for instance).</p>
<p><code>interpolate_data</code> has been designed to perform imputations by groups. For the imputation to be consistent, the <code>groupingvar</code> argument must present the set of keys that uniquely identifies an observation, the year vector being apart. For instance, if the identifiers of an observations are variables called <code>country</code>, <code>region</code>, <code>subregion</code> and <code>year</code>, the individual dimension of our panel will be 3 and <code>groupingvar</code> argument must be provided the following way: <code>groupingvar = c(&quot;country&quot;,&quot;region&quot;,&quot;subregion&quot;)</code>. If we also have a sex dimension, <code>groupingvar</code> will be <code>groupingvar = c(&quot;country&quot;,&quot;region&quot;,&quot;subregion&quot;,&quot;sex&quot;)</code>. It thus provides, for hierarchical levels dataframes, flexibility in defining the individual unit of observation (at least one grouping variable must be provided and as many as needed are accepted). The name of the year variable must be provided in the <code>year.var</code> argument. For each individual unit, a preliminary step checks whether the time dimension is complete, <em>i.e.</em> whether year vector exhibits a complete sequence between its minimum and maximum values. If the time vector is incomplete, intermediate missing years are appended and will also be interpolated thanks to the <code>fill_dataframe</code> function. For instance, assume you have the following incomplete set of years, <code>fill_dataframe</code> will produce</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">year =</span> <span class="kw">c</span>(<span class="dv">1980</span>,<span class="dv">1983</span><span class="op">:</span><span class="dv">1985</span>,<span class="dv">1990</span>),<span class="dt">y =</span> <span class="kw">rnorm</span>(<span class="kw">length</span>(<span class="kw">c</span>(<span class="dv">1980</span>,<span class="dv">1983</span><span class="op">:</span><span class="dv">1985</span>,<span class="dv">1990</span>))))
knitr<span class="op">::</span><span class="kw">kable</span>(df,<span class="dt">caption =</span> <span class="st">&quot;Initial incomplete dataframes&quot;</span>)</code></pre></div>
<table>
<caption>Initial incomplete dataframes</caption>
<thead>
<tr class="header">
<th align="right">year</th>
<th align="right">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1980</td>
<td align="right">-0.7267146</td>
</tr>
<tr class="even">
<td align="right">1983</td>
<td align="right">0.5509210</td>
</tr>
<tr class="odd">
<td align="right">1984</td>
<td align="right">0.1636800</td>
</tr>
<tr class="even">
<td align="right">1985</td>
<td align="right">1.1653539</td>
</tr>
<tr class="odd">
<td align="right">1990</td>
<td align="right">1.1272337</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># FILL DATAFRAME</span>
df &lt;-<span class="st"> </span><span class="kw">fill_dataframe</span>(df,<span class="dt">year.var =</span> <span class="st">'year'</span>,<span class="dt">label.var =</span> <span class="ot">NULL</span>)
knitr<span class="op">::</span><span class="kw">kable</span>(df, <span class="dt">caption =</span> <span class="st">&quot;Missing years have been appended&quot;</span>)</code></pre></div>
<table>
<caption>Missing years have been appended</caption>
<thead>
<tr class="header">
<th align="right">year</th>
<th align="right">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1980</td>
<td align="right">-0.7267146</td>
</tr>
<tr class="even">
<td align="right">1981</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">1982</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">1983</td>
<td align="right">0.5509210</td>
</tr>
<tr class="odd">
<td align="right">1984</td>
<td align="right">0.1636800</td>
</tr>
<tr class="even">
<td align="right">1985</td>
<td align="right">1.1653539</td>
</tr>
<tr class="odd">
<td align="right">1986</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">1987</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">1988</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">1989</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">1990</td>
<td align="right">1.1272337</td>
</tr>
</tbody>
</table>
<p>where the <code>label.var</code> argument has been set to <code>NULL</code> so that it is ignored. Note that <code>year.var = 'year'</code> is the default value and can be avoided. This intermediate function <code>fill_dataframe</code> is important since it is necessary to have a balanced time vector.</p>
<p>The final argument to control the interpolation behavior of <code>interpolate_data</code> is <code>threshold</code>, a parameter that controls which unit of observations, for each variable, will be imputed. It is designed to avoid filling a variable that has too much missing values. More precisely, <code>threshold</code> defines the proportion of missing values by group that is tolerated. If the proportion of missing values, for a given observation unit, is larger than <code>threshold</code>, the variable will not be interpolated. If the proportion of missing values is lower than threshold, observations will be interpolated.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
interpo &lt;-<span class="st"> </span><span class="kw">interpolate_data</span>(df_full[,<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>, <span class="kw">which</span>(<span class="kw">colnames</span>(df_full) <span class="op">==</span><span class="st"> &quot;Zonier&quot;</span>))],
                 <span class="dt">groupingvar =</span> <span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>,<span class="st">&quot;age&quot;</span>,<span class="st">&quot;Country_Transco&quot;</span>, <span class="st">&quot;region&quot;</span>,<span class="st">&quot;ethnicity&quot;</span>),
                 <span class="dt">year.var =</span> <span class="st">'year'</span>, <span class="dt">label.var =</span> <span class="st">'Zonier'</span>,
                 <span class="dt">threshold =</span> <span class="fl">0.2</span>)</code></pre></div>
<p>The output of <code>interpolate_data</code> is made of two elements:</p>
<ul>
<li>First element (<code>data</code>) is the input dataframe with values interpolated.</li>
<li>Second element (<code>matrixNA</code>) is a matrix recording the changes induced by the dataframe. It has the following code: <code>NA</code> if the observation has not been part of any imputation, <code>0</code> if the observation exists and is part of a vector that has been interpolated and <code>1</code> if the observation has been interpolated (or extrapolated).</li>
</ul>
<p>In our case, 152 have been imputed. Keeping a record of the imputations made might be useful to control rows or columns in order to ensure they do not have too many missing values that have been imputed since it can affect the quality of a statistical model. In further versions of the package, some functions will allow post-imputations control.</p>
<p>Let’s call <code>df_full2</code> the new dataframe</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_full2 &lt;-<span class="st"> </span>interpo<span class="op">$</span>data </code></pre></div>
</div>
</div>
<div id="preparing-a-big.matrix" class="section level1">
<h1>Preparing a <code>big.matrix</code></h1>
<p>The dataframe is now ready for statistical modelling. When complete, i.e. when putting <code>colstokeep = NULL</code> rather than <code>colstokeep = 1:100</code> as above, it might be preferrable to use <code>big.matrix</code> object (see <code>bigmemory</code> documentation) rather than standard dataframes.</p>
<p>A drawback of using objects of class <code>big.matrix</code> is that it requires all data to be numeric. This means</p>
<ul>
<li>character vectors must be converted in numeric</li>
<li>factor vectors must be modified otherwise they will be treated as continuous variables by some statistical routines using <code>big.object</code></li>
</ul>
<p>To tackle these issues, two functions have been created:</p>
<ul>
<li><code>convert.character</code> creates a correspondance table between a character variable and a numeric variables allowing to change variable type without loosing information (it calls several times <code>OpenCancer::encode.character</code>)</li>
<li><code>expand.dummies</code> has been designed to transform a factor variable as a set of dummy (as it is treated by statistical models)</li>
</ul>
<div id="converting-character-vectors-as-numeric" class="section level2">
<h2>Converting character vectors as numeric</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
conversion &lt;-<span class="st"> </span><span class="kw">convert.character</span>(df_full2)
<span class="kw">names</span>(conversion)
<span class="co">#&gt; [1] &quot;data&quot;           &quot;correspondance&quot;</span></code></pre></div>
<p><code>convert.character</code> returns a list:</p>
<ul>
<li><code>data</code> returns the dataframe with character variables converted as numeric</li>
<li><code>correspondance</code> is a list of all correspondance tables</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(conversion<span class="op">$</span>data[,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>]), <span class="dt">caption =</span> <span class="st">&quot;Dataframe with converted character vectors&quot;</span>)</code></pre></div>
<table>
<caption>Dataframe with converted character vectors</caption>
<thead>
<tr class="header">
<th align="left">sex</th>
<th align="right">age</th>
<th align="right">Country_Transco</th>
<th align="right">region</th>
<th align="right">ethnicity</th>
<th align="right">year</th>
<th align="right">incidence</th>
<th align="right">1012..5322</th>
<th align="right">1012..5417</th>
<th align="right">1012..5510</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">43</td>
<td align="right">1</td>
<td align="right">1983</td>
<td align="right">21</td>
<td align="right">36986103</td>
<td align="right">177</td>
<td align="right">654654</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">43</td>
<td align="right">1</td>
<td align="right">1984</td>
<td align="right">21</td>
<td align="right">31827029</td>
<td align="right">182</td>
<td align="right">579252</td>
</tr>
<tr class="odd">
<td align="left">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">43</td>
<td align="right">1</td>
<td align="right">1985</td>
<td align="right">21</td>
<td align="right">34277276</td>
<td align="right">184</td>
<td align="right">630702</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">43</td>
<td align="right">1</td>
<td align="right">1986</td>
<td align="right">21</td>
<td align="right">38430073</td>
<td align="right">180</td>
<td align="right">691741</td>
</tr>
<tr class="odd">
<td align="left">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">43</td>
<td align="right">1</td>
<td align="right">1987</td>
<td align="right">21</td>
<td align="right">40037237</td>
<td align="right">180</td>
<td align="right">720670</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">43</td>
<td align="right">1</td>
<td align="right">1988</td>
<td align="right">21</td>
<td align="right">39018836</td>
<td align="right">182</td>
<td align="right">710143</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(conversion<span class="op">$</span>correspondance[[<span class="dv">1</span>]]), <span class="dt">caption =</span> <span class="st">&quot;An example of a correspondance table&quot;</span>)</code></pre></div>
<table>
<caption>An example of a correspondance table</caption>
<thead>
<tr class="header">
<th align="left">value</th>
<th align="right">code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Australia</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Austria</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Brazil</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Canada</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">Colombia</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">Costa Rica</td>
<td align="right">6</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_full2 &lt;-<span class="st"> </span>conversion<span class="op">$</span>data</code></pre></div>
</div>
<div id="creating-set-of-dummies-from-factor-variables" class="section level2">
<h2>Creating set of dummies from factor variables</h2>
<p>This step is not necessary but might be valuable since some models implementation do not accept factor variables or silently convert factors as numeric while they require a different treatment. <code>expand.dummies</code> takes all factor variables - except those provided in the <code>labelvar</code> argument - of a dataframe and creates as many columns as needed to store all possibilities (with a <code>M</code> valued factor, <code>M-1</code> dummies will be created).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_full2<span class="op">$</span>fakefactor &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">size =</span> <span class="kw">nrow</span>(df_full2),
                              <span class="dt">replace =</span> T))

knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(<span class="kw">expand.dummies</span>(df_full2,<span class="dt">labelvar =</span> <span class="st">&quot;sex&quot;</span>)))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">fakefactor_1</th>
<th align="right">fakefactor_2</th>
<th align="right">fakefactor_3</th>
<th align="right">fakefactor_4</th>
<th align="right">fakefactor_5</th>
<th align="right">fakefactor_6</th>
<th align="right">fakefactor_7</th>
<th align="right">fakefactor_8</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>To replace all factor variables in dataframe by the set of dummies:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
factorvar &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">sapply</span>(df_full2,is.factor))
factorvar &lt;-<span class="st"> </span>factorvar[<span class="op">-</span><span class="kw">which</span>(<span class="kw">names</span>(factorvar) <span class="op">==</span><span class="st"> 'sex'</span>)]

df_full2 &lt;-<span class="st"> </span><span class="kw">cbind</span>(df[,<span class="op">-</span>factorvar],<span class="kw">expand.dummies</span>(df_full2,<span class="dt">labelvar =</span> <span class="st">&quot;sex&quot;</span>))</code></pre></div>
</div>
</div>
<div id="other-data-management-functions-in-opencancer" class="section level1">
<h1>Other data management functions in <code>OpenCancer</code></h1>
<p>The <code>OpenCancer</code> package proposes other interesting function to easily build training tables.</p>
<div id="createlag" class="section level2">
<h2><code>createlag</code></h2>
<p>This function has been designed to easily create lagged variables for several columns. Given a maximum order <span class="math inline">\(k\)</span>, each function is lagged at orders <span class="math inline">\(1,...,k\)</span>, taking care of the grouping variables (variables defining the individual unit).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
df_full2 &lt;-<span class="st"> </span><span class="kw">createlag</span>(df_full2[,<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>], <span class="dt">groupingvar =</span> <span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>,<span class="st">&quot;age&quot;</span>,<span class="st">&quot;Country_Transco&quot;</span>,
                                    <span class="st">&quot;region&quot;</span>,<span class="st">&quot;ethnicity&quot;</span>), <span class="dt">k =</span> <span class="dv">2</span>,
                      <span class="dt">labelvar =</span> <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>,<span class="st">&quot;incidence&quot;</span>))

knitr<span class="op">::</span><span class="kw">kable</span>(df_full2[,<span class="kw">colnames</span>(df_full2)[<span class="dv">8</span>]])</code></pre></div>
</div>
<div id="performpreprocess" class="section level2">
<h2><code>performPreProcess</code></h2>
<p>Epidemium do not share common scales. This might affect feature selection in giving too much weight to a few variables. A possibility to limit this problem is centering and scaling all variables before estimating models (and keeping up in memory initial scales to be able to transform back variables to their original scales if needed).</p>
<p>The <code>caret::preProcess</code> allows to that on standard dataframes. The <code>OpenCancer::performPreProcess</code> has been made to apply this function to pointers (see dedicated <code>Vignettes</code>). This function returns a <code>preProcess</code> model that can afterwards be used to transform variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
X &lt;-<span class="st"> </span>df_full[,<span class="dv">1</span><span class="op">:</span><span class="dv">15</span>]
X &lt;-<span class="st"> </span><span class="kw">convert.character</span>(X)<span class="op">$</span>data
Y &lt;-<span class="st"> </span><span class="kw">as.big.matrix</span>(<span class="kw">data.frame</span>(X))

preprocess.model &lt;-<span class="st"> </span><span class="kw">performPreProcess</span>(Y, <span class="dt">groupingvar =</span> <span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>,<span class="st">&quot;age&quot;</span>,<span class="st">&quot;Country_Transco&quot;</span>,
                                     <span class="st">&quot;region&quot;</span>,<span class="st">&quot;ethnicity&quot;</span>),
                  <span class="dt">labelvar =</span> <span class="st">&quot;year&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
readr<span class="op">::</span><span class="kw">write_csv</span>(df_full2,<span class="dt">path =</span> <span class="kw">paste0</span>(datadir,<span class="st">&quot;/exampledf.csv&quot;</span>))</code></pre></div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
